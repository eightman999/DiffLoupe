# DiffLoupe 開発作業ログ

## 作業概要

DiffLoupeフォルダ比較ツールの機能拡張と改善を実施。主にマルチスレッド化、画像比較機能、フィルター機能、ソート機能の実装を行った。

## 実装機能一覧

### 1. マルチスレッド化（バックグラウンド処理）
**目的**: UIブロックの防止とユーザビリティ向上

**実装内容**:
- `FolderComparisonWorker`: フォルダ比較の並列処理
- `FileContentWorker`: テキストファイル読み込みの非同期処理
- `ImageLoadWorker`: 画像読み込みの非同期処理
- `HexLoadWorker`: バイナリファイル読み込みの非同期処理
- プログレスバーによる進捗表示
- アプリケーション終了時の適切なスレッドクリーンアップ

**技術詳細**:
- PySide6の`QThread`と`Signal`を使用
- `try-finally`によるリソース管理
- タイムアウト付きスレッド終了処理

### 2. 拡張画像比較機能
**目的**: 画像ファイルの詳細比較とユーザビリティ向上

**実装内容**:
- **3つの比較モード**:
  - 左右比較: 2つの画像を並べて表示
  - 入れ替え: タイマーによる自動切り替え表示（速度調整可能）
  - スライス: 垂直分割による重ね合わせ比較（スライダー制御）
- **ズーム・スケーリング機能**:
  - ウィンドウに合わせる（自動スケーリング）
  - 実際のサイズ表示
  - ズームイン/アウト（ボタンまたはCtrl+マウスホイール）
  - リセット機能
- **対応画像形式**: PNG, JPG, TGA, DDS, BMP（Pillow使用）

**技術詳細**:
- `QPainter`による高品質な画像合成
- `QScrollArea`による大画像対応
- `QTimer`による自動切り替え制御

### 3. ツリーフィルター機能
**目的**: 大量ファイルでの効率的な差分確認

**実装内容**:
- **3つのフィルターモード**:
  - すべて: 全ファイル表示（デフォルト）
  - 欠落・新規のみ: 片方のフォルダにのみ存在するファイル
  - 差分のみ: 内容に違いがあるファイル
- **UI機能**:
  - ファイル数表示（現在/総数）
  - ワンクリックリセット
  - 自動ツリー展開（結果が少ない場合）

**技術詳細**:
- 効率的なツリー再構築アルゴリズム
- フォルダ階層の動的生成
- XOR論理による欠落ファイル検出

### 4. ソート機能
**目的**: ファイルの並び順カスタマイズ

**実装内容**:
- **6つのソートオプション**:
  - 名前（昇順/降順）
  - 更新日時（昇順/降順）
  - ファイルサイズ（昇順/降順）
- **comparator.py拡張**: ファイルメタデータ収集
- **フィルターとの統合**: フィルター後にソート適用

**技術詳細**:
- `os.stat`による効率的なメタデータ収集
- カスタムソートキー関数
- 大文字小文字を区別しない文字列比較

### 5. エンコーディング対応拡張
**目的**: 多様な文字コードファイルへの対応

**実装内容**:
- **15種類のエンコーディング対応**:
  - Unicode系: UTF-8, UTF-16, UTF-32
  - 日本語: Shift_JIS, EUC-JP, CP932, ISO-2022-JP
  - 欧州・アジア: Windows-1252, ISO-8859-1, Big5, GB2312, GBK, KS_C_5601-1987
  - その他: ASCII, Auto-detect
- **エラーハンドリング強化**: エンコーディング失敗時の適切な対応

### 6. 隠しファイル表示制御
**目的**: システムファイルの表示/非表示切り替え

**実装内容**:
- ドット（.）で始まるファイル・フォルダの表示制御
- `os.walk`のディレクトリフィルタリング
- ツールチップによる機能説明

### 7. UI/UXの改善
**目的**: 操作性とデザインの向上

**実装内容**:
- **コンパクトレイアウト**: 設定エリアを2行構成に変更
- **キーボードショートカット**:
  - Ctrl+1/2/3: フィルター切り替え
  - Ctrl+R: リセット
  - F5: 比較実行
  - Ctrl+S: ソートフォーカス
- **視覚改善**: 区切り線、統一された高さ制限、適切なスペーシング

### 8. エラー処理とバグ修正
**実装内容**:
- QThreadの適切な終了処理
- QPainterリソース管理の改善
- QRectインポートエラーの修正
- QSizePolicyの正しいAPI使用
- Qtフォント警告の抑制

## 技術スタック

### フレームワーク・ライブラリ
- **PySide6**: メインGUIフレームワーク
- **Pillow**: 画像処理（TGA, DDS対応）
- **chardet**: 文字エンコーディング自動判定
- **multiprocessing**: ハッシュ計算の並列処理

### アーキテクチャパターン
- **MVC**: UI、ロジック、データの分離
- **Observer**: Signal-Slotパターンによるイベント処理
- **Worker Thread**: バックグラウンド処理による応答性向上

## パフォーマンス最適化

### 実装した最適化
1. **段階的比較**: メタデータ → ハッシュの順で効率的比較
2. **並列ハッシュ計算**: マルチプロセシングによる高速化
3. **非同期ファイル読み込み**: UIブロックの防止
4. **効率的ツリー構築**: 必要時のみ再構築
5. **メモリ効率**: 適切なリソース管理とクリーンアップ

## ファイル構成

### 主要ファイル
- `main.py`: アプリケーションエントリポイント、ログ設定
- `ui_main.py`: メインUI、全機能の統合
- `comparator.py`: フォルダ比較ロジック、ファイル情報収集
- `requirements.txt`: 依存ライブラリ
- `CLAUDE.md`: 開発ガイドライン
- `run.sh`: 警告抑制起動スクリプト

### 新規追加
- `WORK_LOG.md`: 本作業ログ

## 今後の課題・改善点

### 機能拡張案
1. **差分ビューの改善**: より詳細な差分表示
2. **バックアップ機能**: 差分ファイルの自動バックアップ
3. **プラグインシステム**: カスタム比較ロジックの追加
4. **設定の永続化**: ユーザー設定の保存・復元

### パフォーマンス改善案
1. **増分比較**: 変更されたファイルのみ再比較
2. **キャッシュシステム**: ハッシュ値のキャッシュ
3. **プログレス詳細化**: より細かい進捗表示

## 開発環境

- **OS**: macOS (Darwin 24.5.0)
- **Python**: 3.x
- **IDE**: Claude Code
- **バージョン管理**: 未使用（ローカル開発）

## テスト状況

### 実施済みテスト
- 基本的なフォルダ比較動作
- 各表示モードの切り替え
- フィルター機能の動作
- ソート機能の動作
- キーボードショートカット
- エラーハンドリング

### 今後必要なテスト
- 大量ファイルでのパフォーマンステスト
- 各種画像形式での表示テスト
- 異なるエンコーディングでのテスト
- 長時間動作でのメモリリークテスト

---

**作業完了日**: 2025年7月1日  
**総作業時間**: 約6時間  
**実装機能数**: 8つの主要機能  
**修正バグ数**: 5つの重要バグ修正